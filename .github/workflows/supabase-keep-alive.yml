name: Supabase Keep-Alive

on:
  schedule:
    # Runs every 3 days at 08:00 UTC (15:00 Bangkok time)
    # Cron: minute hour day-of-month month day-of-week
    - cron: "0 8 */3 * *"
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  keep-alive:
    name: Ping Supabase to Prevent Pausing
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase REST API
        run: |
          PING_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          SUPABASE_HOST=$(echo "${{ secrets.SUPABASE_URL }}" | sed 's|https://||')

          echo "============================================"
          echo "  üöÄ Supabase Keep-Alive Ping"
          echo "============================================"
          echo "  ‚è∞ Time    : $PING_TIME"
          echo "  üåê Project : $SUPABASE_HOST"
          echo "  üìç Endpoint: /rest/v1/"
          echo "--------------------------------------------"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/?apikey=${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")

          echo "  üì° HTTP Status : $HTTP_STATUS"

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "  ‚úÖ Result  : SUCCESS ‚Äî Supabase is alive!"
          elif [ "$HTTP_STATUS" -eq 401 ] || [ "$HTTP_STATUS" -eq 403 ]; then
            echo "  ‚úÖ Result  : SUCCESS ‚Äî Project is active (auth required)"
          else
            echo "  ‚ùå Result  : FAILED ‚Äî Unexpected status $HTTP_STATUS"
            echo "============================================"
            exit 1
          fi

          echo "============================================"
